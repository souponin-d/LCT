# LCT – Local CTG Toolkit

Набор инструментов для локального анализа кардиотокографии (КТГ): загрузка данных, извлечение медицинских сущностей, детекция артефактов, спектральный и вейвлет‑анализ, а также агрегированный разбор по пациентам и группам (гипоксия/контроль).

## Архитектура проекта

```
.
├── backend/                      # FastAPI-приложение (базовые эндпоинты)
│   └── app/
│       ├── __init__.py
│       └── main.py               # health / ingest / stream
├── data/                         # Датасет для анализа
│   ├── hypoxia/                  # Пациентки с гипоксией
│   │   └── <patient_id>/{bpm,uterus}/*.csv   # time_sec,value
│   ├── regular/                  # Контрольная группа
│   │   └── <patient_id>/{bpm,uterus}/*.csv
│   ├── hypoxia.xlsx              # Сводные таблицы (при наличии)
│   └── regular.xlsx
├── emulator/
│   ├── __init__.py
│   └── realtime_emulator.py      # Проигрывание архивов (опционально)
├── frontend/                     # Заготовка под UI
│   ├── public/
│   └── src/
├── ctg_analysis.py               # Модуль анализа КТГ (сущности/артефакты/классификация)
├── ctg_data_processor.py         # Массовая обработка и агрегация результатов
├── data_analysis.ipynb           # Исследовательский анализ (EDA), спектры, CWT, графики
├── ctg_demo.ipynb                # Демонстрация КТГ-аналитики на симулированных данных
├── main.py                       # Общий запуск эмулятора + backend (при необходимости)
└── README.md
```

## Требования и установка

- Python 3.8+
- Рекомендуемые пакеты: numpy, pandas, scipy, matplotlib, seaborn, tqdm, pywt, fastapi, uvicorn

Установка зависимостей (пример через pip):

```bash
pip install numpy pandas scipy matplotlib seaborn tqdm pywt fastapi uvicorn
```

## Структура данных

- Каталоги `data/hypoxia` и `data/regular` содержат подкаталоги пациентов `1, 2, 3, ...`.
- Внутри каждого пациента две папки: `bpm/` (ЧСС плода, FHR) и `uterus/` (маточная активность, UC).
- Формат файлов: CSV c колонками `time_sec,value`.

Пример пути:

```
data/hypoxia/1/bpm/20250908-07500001_1.csv
data/hypoxia/1/uterus/20250908-07500001_2.csv
```

## Быстрый старт

### EDA в ноутбуке

Откройте `data_analysis.ipynb` и выполните ячейки последовательно:

- Обзор структуры данных и выборки
- Временные ряды BPM/uterus
- Сравнительные графики hypoxia vs regular
- Распределения/boxplot
- Спектр (Welch/FFT), спектрограммы и вейвлет‑скалограммы (CWT)

### Демонстрация на симулированных данных

Откройте `ctg_demo.ipynb` для генерации синтетических КТГ‑сигналов (норма, гипоксия, тахи/бради) и визуализации характеристик.

### Запуск массового анализа

Пример запуска из `ctg_data_processor.py` (анализ небольшой выборки):

```bash
python ctg_data_processor.py
```

Скрипт загрузит данные из `data/`, синхронизирует пары BPM/uterus, выполнит анализ по файлам и пациентам, сохранит агрегированные результаты в `ctg_demo_results.json` и выведет краткий отчёт в консоль.

## Аналитические возможности (модуль `ctg_analysis.py`)

Модуль реализует извлечение медицинских сущностей, детекцию артефактов и классификацию состояния плода.

- Базальная ЧСС (БЧСС, 10‑мин окна, исключение акцелераций/децелераций)
- Вариабельность: 
  - STV (кратковременная, мс)
  - LTV (долговременная, амплитуда и частота осцилляций)
- Акцелерации: ≥ 15 уд/мин, 15 сек – 10 мин, реактивность (NST)
- Децелерации: ранние, поздние, вариабельные, пролонгированные (связь со схватками)
- Маточная активность: частота за 10 мин, длительность, амплитуда, базальный тонус
- Артефакты: потеря сигнала, экстремальные выбросы, высокочастотный шум
- Оценка по Фишеру (0–8), классификация FIGO (норм/сомнит/патол), стадийность гипоксии

### Пример использования API

```python
from ctg_analysis import CTGAnalyzer
import numpy as np

# fhr и uc — массивы с равномерной дискретизацией (например, 4 Гц)
analyzer = CTGAnalyzer(sampling_rate=4.0)
results = analyzer.comprehensive_analysis(fhr_signal=fhr, uc_signal=uc)

print(results['baseline_fhr'])
print(results['variability'])
print(results['accelerations']['total_count'])
print(results['decelerations']['type_counts'])
print(results['fetal_condition'])
```

Ключи результата:

- `signal_quality` – артефакты, длительность, quality_score
- `baseline_fhr` – БЧСС и её стабильность
- `variability` – STV/LTV и тип кривой
- `accelerations`, `decelerations` – списки и сводные метрики
- `uterine_activity` – параметры схваток и тонуса
- `fisher_score`, `fetal_condition` – итоговые баллы/классификации и рекомендации

## Спектральный и вейвлет‑анализ (в `data_analysis.ipynb`)

- `plot_psd_and_fft(...)` – спектр мощности (Welch) и амплитудный спектр (FFT)
- `plot_spectrogram(...)` – спектрограммы с управлением верхней частотой (`fmax`)
- `cwt_spectrogram(...)` – непрерывное вейвлет‑преобразование (Морле), скалограммы

Эти блоки помогают оценить диапазоны частот, динамику во времени и локальные паттерны (например, синусоидальность, высокочастотный шум и пр.).

## Backend и эмулятор (опционально)

### Эмулятор реального времени

`emulator/realtime_emulator.py` читает архив и воспроизводит данные партиями.

Пример запуска:

```bash
python -m emulator.realtime_emulator data/archive/sample.json --time-step 500 --batch-size 20 --max-batches 10
```

### Backend‑заглушка

FastAPI (`backend/app/main.py`) предоставляет:

- `GET /health` – проверка живости
- `POST /ingest` – приём батча
- `GET /stream` – получение последнего батча

Совместный запуск:
=======
## Совместный запуск эмулятора и бэкенда

Оба компонента можно запустить одной командой:
>>>>>>> 687e6ed13206cf553060cc5a3497d5119da90f04

```bash
python main.py -t 500 -b 20
```

<<<<<<< HEAD
Параметры `-t/--time-step` и `-b/--batch-size` передаются эмулятору. Адрес бэкенда можно переопределить флагами `--host`/`--port`.


Параметры `-t/--time-step` и `-b/--batch-size` передаются эмулятору. 
>>>>>>> 687e6ed13206cf553060cc5a3497d5119da90f04
